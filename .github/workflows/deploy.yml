name: Deploy to Coder

on:
  push:
    branches: [main]
    paths:
      - 'main.tf'
      - 'build/**'
  workflow_dispatch:
    inputs:
      template_name:
        description: 'Template name (optional override)'
        required: false
        default: ''

jobs:
  deploy:
    name: Deploy Template to Coder
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Coder CLI
        run: |
          curl -fsSL https://coder.com/install.sh | sh
          coder version

      - name: Configure Coder CLI
        env:
          CODER_URL: ${{ secrets.CODER_URL }}
          CODER_SESSION_TOKEN: ${{ secrets.CODER_SESSION_TOKEN }}
        run: |
          # Verify required secrets are set
          if [ -z "$CODER_URL" ]; then
            echo "Error: CODER_URL secret not set"
            exit 1
          fi
          if [ -z "$CODER_SESSION_TOKEN" ]; then
            echo "Error: CODER_SESSION_TOKEN secret not set"
            exit 1
          fi

          # Configure CLI
          echo "Configured Coder CLI for: $CODER_URL"

      - name: Determine template name
        id: template
        run: |
          if [ -n "${{ github.event.inputs.template_name }}" ]; then
            TEMPLATE_NAME="${{ github.event.inputs.template_name }}"
          else
            TEMPLATE_NAME="bufo-template"
          fi
          echo "name=$TEMPLATE_NAME" >> $GITHUB_OUTPUT
          echo "Using template name: $TEMPLATE_NAME"

      - name: Push template to Coder
        env:
          CODER_URL: ${{ secrets.CODER_URL }}
          CODER_SESSION_TOKEN: ${{ secrets.CODER_SESSION_TOKEN }}
        run: |
          # Create or update template
          # Note: Uses default variables from main.tf (cpu=4, memory_mb=8192)
          coder templates push ${{ steps.template.outputs.name }} \
            --directory . \
            --yes

      - name: Get template info
        env:
          CODER_URL: ${{ secrets.CODER_URL }}
          CODER_SESSION_TOKEN: ${{ secrets.CODER_SESSION_TOKEN }}
        run: |
          echo "Template deployed successfully!"
          coder templates list | grep ${{ steps.template.outputs.name }} || true

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Template deployed to Coder successfully!\n\nTemplate: `${{ steps.template.outputs.name }}`'
            })
