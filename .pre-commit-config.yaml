# Pre-commit hooks for Coder template validation
# Install: pip install pre-commit && pre-commit install
# Run manually: pre-commit run --all-files

repos:
  # Terraform validation
  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.96.1
    hooks:
      - id: terraform_fmt
        name: Format Terraform files
        description: Rewrites Terraform files to canonical format

      - id: terraform_validate
        name: Validate Terraform configuration
        description: Validates all Terraform files
        args:
          - --hook-config=--retry-once-with-cleanup=true

      - id: terraform_docs
        name: Generate Terraform docs
        description: Inserts terraform-docs output into README.md
        args:
          - --hook-config=--path-to-file=README.md
          - --hook-config=--add-to-existing-file=true
          - --hook-config=--create-file-if-not-exist=true
        files: main\.tf$

  # Dockerfile validation
  - repo: https://github.com/hadolint/hadolint
    rev: v2.12.0
    hooks:
      - id: hadolint-docker
        name: Lint Dockerfile
        description: Runs hadolint to lint Dockerfiles
        entry: hadolint
        language: docker_image
        types: ["dockerfile"]
        args:
          - --ignore=DL3008  # Pin versions in apt-get (we use dnf)
          - --ignore=DL3018  # Pin versions in apk (we use dnf)

  # General file checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: trailing-whitespace
        name: Trim trailing whitespace

      - id: end-of-file-fixer
        name: Fix end of files

      - id: check-yaml
        name: Check YAML syntax
        args: ['--unsafe']  # Allow custom tags in GitHub Actions

      - id: check-added-large-files
        name: Check for large files
        args: ['--maxkb=1000']

      - id: check-merge-conflict
        name: Check for merge conflicts

      - id: mixed-line-ending
        name: Check line endings

  # Shell script validation
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.10.0.1
    hooks:
      - id: shellcheck
        name: Check shell scripts
        args: ['-x', '-S', 'warning']

# Custom local hooks for Coder-specific checks
  - repo: local
    hooks:
      - id: coder-template-check
        name: Check Coder template requirements
        entry: bash -c 'grep -q "coder/coder" main.tf || (echo "Error: Coder provider not found in main.tf" && exit 1)'
        language: system
        files: main\.tf$
        pass_filenames: false

      - id: check-docker-build
        name: Test Docker build
        entry: bash -c 'cd build && docker build -t bufo-template-test . > /dev/null 2>&1 || (echo "Error: Docker build failed" && exit 1)'
        language: system
        files: build/Dockerfile
        pass_filenames: false

      - id: check-todo-markers
        name: Check for TODO/FIXME markers
        entry: bash -c 'if grep -rn "TODO\|FIXME\|XXX" main.tf build/Dockerfile 2>/dev/null; then echo "Warning: Found TODO/FIXME markers (not blocking)"; fi; exit 0'
        language: system
        pass_filenames: false
